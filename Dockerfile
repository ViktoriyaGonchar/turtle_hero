# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ .NET 8 SDK –¥–ª—è —Å–±–æ—Ä–∫–∏
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
COPY ["TurtleHero.sln", "./"]
COPY ["src/TurtleHero.Core/TurtleHero.Core.csproj", "src/TurtleHero.Core/"]
COPY ["src/TurtleHero.Avalonia/TurtleHero.Avalonia.csproj", "src/TurtleHero.Avalonia/"]
COPY ["tests/TurtleHero.Core.Tests/TurtleHero.Core.Tests.csproj", "tests/TurtleHero.Core.Tests/"]
COPY ["tests/TurtleHero.Integration/TurtleHero.Integration.csproj", "tests/TurtleHero.Integration/"]

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN dotnet restore "TurtleHero.sln"

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
WORKDIR /src
RUN dotnet build "TurtleHero.sln" -c Release --no-restore

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã (–∏—Å–∫–ª—é—á–∞–µ–º Avalonia –ø—Ä–æ–µ–∫—Ç, —Ç–∞–∫ –∫–∞–∫ UI –Ω–µ –Ω—É–∂–µ–Ω –≤ Docker)
FROM build AS test
WORKDIR /src
RUN dotnet test tests/TurtleHero.Core.Tests/TurtleHero.Core.Tests.csproj -c Release --no-build --verbosity normal
RUN dotnet test tests/TurtleHero.Integration/TurtleHero.Integration.csproj -c Release --no-build --verbosity normal

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
FROM mcr.microsoft.com/dotnet/runtime:8.0 AS runtime
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, UI –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ Docker)
# –î–ª—è Avalonia UI –Ω—É–∂–Ω–∞ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—Ä–µ–¥–∞, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ Core –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º SDK –æ–±—Ä–∞–∑
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS dev
WORKDIR /workspace

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
RUN apt-get update && apt-get install -y \
    git \
    vim \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —á—Ç–æ –º—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
ENV DOTNET_RUNNING_IN_CONTAINER=true

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
COPY . .

# –°–æ–∑–¥–∞—ë–º —Å–∫—Ä–∏–ø—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
RUN echo '#!/bin/bash\n\
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"\n\
echo "‚ïë  üê¢ –ß–µ—Ä–µ–ø–∞—à–∫–∞-–≥–µ—Ä–æ–π - –ó–∞–ø—É—Å–∫ –≤ Docker                     ‚ïë"\n\
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"\n\
if [ "$1" == "run-avalonia" ]; then\n\
    echo "‚ïë  ‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ GUI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Docker      ‚ïë"\n\
    echo "‚ïë                                                        ‚ïë"\n\
    echo "‚ïë  Avalonia UI —Ç—Ä–µ–±—É–µ—Ç –≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é —Å—Ä–µ–¥—É!                ‚ïë"\n\
    echo "‚ïë  –≠—Ç–æ –ù–ï –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ X11/Wayland forwarding!     ‚ïë"\n\
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"\n\
    dotnet run --project src/TurtleHero.Avalonia/TurtleHero.Avalonia.csproj\n\
elif [ "$1" == "test" ]; then\n\
    echo "‚ïë  –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...                                       ‚ïë"\n\
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"\n\
    dotnet test\n\
elif [ "$1" == "build" ]; then\n\
    echo "‚ïë  –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...                                      ‚ïë"\n\
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"\n\
    dotnet build\n\
else\n\
    echo "‚ïë  –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:                                     ‚ïë"\n\
    echo "‚ïë    run-avalonia  - –ó–∞–ø—É—Å—Ç–∏—Ç—å Avalonia UI (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!)‚ïë"\n\
    echo "‚ïë    test          - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã                 ‚ïë"\n\
    echo "‚ïë    build         - –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç                      ‚ïë"\n\
    echo "‚ïë                                                        ‚ïë"\n\
    echo "‚ïë  –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ GUI –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Windows –Ω–∞–ø—Ä—è–º—É—é!      ‚ïë"\n\
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"\n\
    exec /bin/bash\n\
fi\n\
' > /usr/local/bin/turtle-hero && chmod +x /usr/local/bin/turtle-hero

# –°–æ–∑–¥–∞—ë–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
CMD ["/bin/bash"]

