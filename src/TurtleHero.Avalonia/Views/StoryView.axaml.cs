using System;
using System.Threading.Tasks;
using Avalonia.Controls;
using Avalonia.Input;
using Avalonia.Interactivity;
using Avalonia.Markup.Xaml;

namespace TurtleHero.Avalonia.Views;

public partial class StoryView : UserControl
{
    public event Action? OnStoryComplete;
    
    private const string StoryText = @"–í –¥–∞–ª—ë–∫–æ–º –º–∏—Ä–µ –≠–º–æ–¥–∑–∏-–ê—Ä—Ö–∏–ø–µ–ª–∞–≥–∞ üåç, –≥–¥–µ –∫–∞–∂–¥–æ–µ —Å—É—â–µ—Å—Ç–≤–æ –≤—ã—Ä–∞–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —ç–º–æ–¥–∑–∏ –∏ –∂–∏–≤—ë—Ç –≤ –≥–∞—Ä–º–æ–Ω–∏–∏ —Å –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –ø—Ä–∏—Ä–æ–¥–æ–π, –Ω–∞—Å—Ç—É–ø–∞–µ—Ç —ç–ø–æ—Ö–∞ —Ö–∞–æ—Å–∞.

–ó–ª–æ–±–Ω—ã–π –ó–º–µ–∏–Ω—ã–π –¢–∏—Ä–∞–Ω üêç –ø–æ—Ö–∏—Ç–∏–ª –°–≤–∏—Ç–æ–∫ –ú—É–¥—Ä–æ—Å—Ç–∏ üìú ‚Äî –¥—Ä–µ–≤–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –¥–æ–±—Ä–æ–º –∏ –∑–ª–æ–º.

–ë–µ–∑ –Ω–µ–≥–æ –¥–µ—Ä–µ–≤—å—è —Å–æ—Ö–Ω—É—Ç üåµ, —Ä–µ–∫–∏ –º—É—Ç–Ω–µ—é—Ç üíß, –∞ –¥–∞–∂–µ —Å–æ–ª–Ω—Ü–µ üåû —Å—Ç–∞–ª–æ —Ö–º—É—Ä–∏—Ç—å—Å—è.

–ù–æ –Ω–∞–¥–µ–∂–¥–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–∞! –ò–∑ –≥–ª—É–±–∏–Ω –±–æ–ª–æ—Ç–∞ –≤—ã—Ö–æ–¥–∏—Ç –¢–æ—Ä—Ç–∏–ª–ª–∞ üê¢ ‚Äî —Å–∫—Ä–æ–º–Ω–∞—è, –Ω–æ –º—É–¥—Ä–∞—è —á–µ—Ä–µ–ø–∞—Ö–∞, –≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏—Ü–∞ —Å—Ç–∞—Ä–æ–≥–æ –º—É–¥—Ä–µ—Ü–∞-—Å–æ–≤—ã ü¶â.

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —É –Ω–µ—ë –∂–µ–ª–µ–∑–Ω–∞—è –ø–∞–Ω—Ü–∏—Ä–Ω–∞—è –≤–æ–ª—è, –æ—Å—Ç—Ä—ã–π —É–º –∏... –º–µ—á –∏–∑ —Ä–∞–∫—É—à–∫–∏ üó°Ô∏èüêö!

–¢–æ—Ä—Ç–∏–ª–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑:
‚Ä¢ –õ–µ—Å –®—ë–ø–æ—Ç–∞ üå≥ (–≥–¥–µ –≥–æ–≤–æ—Ä—è—Ç –¥–µ—Ä–µ–≤—å—è)
‚Ä¢ –ü—É—Å—Ç—ã–Ω—é –õ–µ–Ω–∏ üí® (–≥–¥–µ –¥–∞–∂–µ –≤–µ—Ç–µ—Ä —É—Å—Ç–∞–ª)
‚Ä¢ –ì–æ—Ä—ã –ì–æ—Ä–¥—ã–Ω–∏ ü¶Ö (–≥–¥–µ –∂–∏–≤—É—Ç –≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω—ã–µ –æ—Ä–ª—ã)
‚Ä¢ –ò, –Ω–∞–∫–æ–Ω–µ—Ü, –ó–º–µ–∏–Ω–æ–µ –ì–Ω–µ–∑–¥–æ ‚Äî –ª–æ–≥–æ–≤–æ –¢–∏—Ä–∞–Ω–∞

–ü–æ –ø—É—Ç–∏ –æ–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —Å–æ—é–∑–Ω–∏–∫–æ–≤ (üçÑ –≥—Ä–∏–±-—Ü–µ–ª–∏—Ç–µ–ª—å, üê∏ –ª—è–≥—É—à–∫–∞-—Ä–∞–∑–≤–µ–¥—á–∏–∫), —Ä–µ—à–∞–µ—Ç –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏, –≤–µ–¥—ë—Ç –¥–∏–∞–ª–æ–≥–∏ —Å –º–æ—Ä–∞–ª—å–Ω—ã–º–∏ –≤—ã–±–æ—Ä–∞–º–∏ –∏ —Å—Ä–∞–∂–∞–µ—Ç—Å—è —Å –≤—Ä–∞–≥–∞–º–∏.

–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è: –±–∏—Ç–≤–∞ —Å –ó–º–µ–∏–Ω—ã–º –¢–∏—Ä–∞–Ω–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∞–º—É —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –≠–º–æ–¥–∑–∏-–ê—Ä—Ö–∏–ø–µ–ª–∞–≥–∞, –ø—Ä–µ–≤—Ä–∞—Ç–∏–≤ –≤—Å–µ—Ö –≤ –±–µ–∑–º–æ–ª–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.

–§–∏–Ω–∞–ª –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–≤–æ–∏—Ö –≤—ã–±–æ—Ä–æ–≤... üé≠";

    public StoryView()
    {
        InitializeComponent();
        Loaded += StoryView_Loaded;
        this.KeyDown += StoryView_KeyDown;
    }

    private void InitializeComponent()
    {
        AvaloniaXamlLoader.Load(this);
    }

    private async void StoryView_Loaded(object? sender, RoutedEventArgs e)
    {
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        await AnimateStoryText();
    }

    private async Task AnimateStoryText()
    {
        if (StoryTextBlock == null) return;
        
        StoryTextBlock.Text = "";
        
        foreach (var paragraph in StoryText.Split(new[] { "\n\n" }, StringSplitOptions.None))
        {
            foreach (var line in paragraph.Split('\n'))
            {
                StoryTextBlock.Text += line + "\n";
                await Task.Delay(50); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
            }
            StoryTextBlock.Text += "\n";
            await Task.Delay(300);
        }
    }

    private void StoryView_KeyDown(object? sender, KeyEventArgs e)
    {
        if (e.Key == Key.Space || e.Key == Key.Enter)
        {
            ContinueStory();
        }
    }

    private void ContinueButton_Click(object? sender, RoutedEventArgs e)
    {
        ContinueStory();
    }

    private void ContinueStory()
    {
        OnStoryComplete?.Invoke();
    }
}
